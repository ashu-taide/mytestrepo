---
version: 1.0.0
ssh-keys:
  acquia_chromium_tests:
    secure: 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 
services:
  - mysql
events:
  build:
    steps:
      - behaviors:
          type: script
          script:
            - echo "Setting metadata"
            - pipelines_metadata 'hello' 'world'
            - echo "Executing default event"
            - echo "Creating a long-running background job that should be killed"
            - 'sleep 3700 &'
            - 'jobs -p > /tmp/bg.pid'
            - echo "Testing env vars"
            - 'echo "CI=" : ${CI?"Need to set CI"}'
            - 'echo "CONTINUOUS_INTEGRATION=" : ${CONTINUOUS_INTEGRATION?"Need to set CONTINUOUS_INTEGRATION"}'
            - 'echo "PIPELINE_STATUS=" : ${PIPELINE_STATUS?"Need to set PIPELINE_STATUS"}'
            - 'echo "PIPELINE_ENV=" : ${PIPELINE_ENV?"Need to set ENV"}'
            - 'echo "PIPELINE_APPLICATION_ID=" : ${PIPELINE_APPLICATION_ID?"Need to set PIPELINE_APPLICATION_ID"}'
            - 'echo "PIPELINE_JOB_ID=" : ${PIPELINE_JOB_ID?"Need to set PIPELINE_JOB_ID"}'
            - 'echo "PIPELINE_VCS_PATH=" : ${PIPELINE_VCS_PATH?"Need to set PIPELINE_VCS_PATH"}'
            - 'echo "PIPELINE_DEPLOY_VCS_PATH=" : ${PIPELINE_DEPLOY_VCS_PATH?"Need to set PIPELINE_DEPLOY_VCS_PATH"}'
            - 'echo "PIPELINE_CLOUD_REALM=" : ${PIPELINE_CLOUD_REALM?"Need to set PIPELINE_CLOUD_REALM"}'
            - 'echo "PIPELINE_CLOUD_SITE=" : ${PIPELINE_CLOUD_SITE?"Need to set PIPELINE_CLOUD_SITE"}'
            - 'echo "PIPELINE_GIT_HEAD_REF=" : ${PIPELINE_GIT_HEAD_REF?"Need to set PIPELINE_GIT_HEAD_REF"}'
            - export PERSISTENT_VAR=persistent
            - 'echo "Testing custom ENV vars"'
            - echo $MY_VAR_3
            - echo $MY_VAR_4
            - 'echo "Testing persisting env vars across events"'
            - "echo '{ \"environment\": { \"new_var_1\":\"new_val_1\" } }' > \"${PIPELINES_SCRIPT_DATA_FILE}\""
            - echo "Testing mysql service"
            - mysqladmin -uroot -proot create test_database
            - "echo 'SHOW DATABASES' | mysql -uroot -proot | grep test_database "
            - 'echo "CREATE TABLE test_table (c1 INT NOT NULL AUTO_INCREMENT PRIMARY KEY, c2 VARCHAR(100));" | mysql -uroot -proot test_database'
            - 'echo "INSERT INTO test_table VALUES (NULL, \"buildsteps\");" | mysql -uroot -proot test_database'
            - 'echo "SELECT * FROM test_table;" | mysql -uroot -proot test_database | grep buildsteps'
            - 'echo "Testing NVM"'
            - nvm --version
            - nvm install 4.4.1
            - nvm use 4.4.1
            - npm install color
            - find . -name ".git" -type d -exec rm -r "{}" +
            - 'echo "Testing Memory Monitor"'
            - pipelines-memory-monitor-status || echo "Could not locate the memory monitor status command"
            - 'echo "Validating validity of container certs"'
            - sudo /usr/local/src/pipelines-logtailor/bin/validate_cert /etc/pipelines_config/ssl.cert /etc/pipelines_config/ssl.key
            - 'echo "Testing headless chrome browser"'
            - google-chrome --version
            - cd headless-chrome-test && npm install && node_modules/karma-cli/bin/karma start --single-run
      - background-check:
          type: script
          script:
            - 'test -d /proc/$(cat /tmp/bg.pid) && echo "Background job is still running."'
      - variable-across-steps-check:
          type: script
          script:
            - 'echo "PERSISTENT_VAR=" : ${PERSISTENT_VAR?"Need to set PERSISTENT_VAR"}'
  custom:
    steps:
      - steptwo:
          type: script
          script:
            - 'echo "Executing custom event"'
            - 'echo "I have slashes"'
  post-deploy:
    steps:
      - cat:
         type: script
         script:
         - echo 'Executing post-deploy event'
         - 'echo "new_var_1=" : ${new_var_1?"Need to set new_var_1"}'
